apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: deploy-app-pipeline
  title: Deploy Application via Pipeline
  description: A template to deploy applications using the OpenShift pipeline across multiple namespaces.
spec:
  owner: backstage/dev-hub-team
  type: service

  parameters:
    - title: Deployment Information
      required:
        - repositoryUrl
        - deploymentName
        - configMapName
        - pvcName
        - namespace
      properties:
        repositoryUrl:
          title: Repository URL
          type: string
          description: URL of the Git repository to clone
          ui:options:
            rows: 1
        deploymentName:
          title: Deployment Name
          type: string
          description: Unique name of the deployment
          ui:options:
            rows: 1
        configMapName:
          title: ConfigMap Name
          type: string
          description: Specify the name of the ConfigMap to use
          ui:options:
            rows: 1
        pvcName:
          title: PVC Name
          type: string
          description: Specify the name of the PVC to use for the repository
          ui:options:
            rows: 1
        namespace:
          title: Namespace Name
          type: string
          description: Specify the Kubernetes namespace for the deployment
          ui:autofocus: true
          ui:options:
            rows: 1

  steps:
    - id: fetch-base
      name: Fetch Base Template
      action: fetch:template
      input:
        url: ./template
        values:
          repositoryUrl: ${{ parameters.repositoryUrl }}
          deploymentName: ${{ parameters.deploymentName }}
          configMapName: ${{ parameters.configMapName }}
          pvcName: ${{ parameters.pvcName }}
          namespace: ${{ parameters.namespace }}

    - id: register
      name: Register Component
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.fetch-base.output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'

    - id: deploy-pipeline
      name: Deploy Application
      action: tekton:run
      input:
        pipeline: deploy-app-pipeline
        parameters:
          repository-url: ${{ parameters.repositoryUrl }}
          image-name: "registry.redhat.io/rhel8/httpd-24:1-335.1724231549"  # Default value
          deployment-name: ${{ parameters.deploymentName }}
          configmap-name: ${{ parameters.configMapName }}
          pvc-name: ${{ parameters.pvcName }}
          namespace: ${{ parameters.namespace }}
